<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Simulador de Recarga NFC - Mexibús (Prototipo)</title>
<style>
  :root{
    --bg:#f6f7fb;
    --card:#ffffff;
    --accent:#0b74ff;
    --muted:#6b7280;
    --success:#0f9d58;
    --error: #dc3545; /* Nuevo color de error */
  }
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial; background:var(--bg); margin:0; color:#111;}
  .wrap{max-width:900px;margin:28px auto;padding:20px;}
  header{display:flex;align-items:center;gap:16px}
  h1{font-size:20px;margin:0}
  p.lead{margin:6px 0 0;color:var(--muted)}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:18px;margin-top:18px}
  /* Estética: Sombra sutil y transición */
  .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 6px 18px rgba(15,23,42,0.06); transition: box-shadow 0.3s ease; border: 1px solid #f0f0f0;}
  .card:hover {box-shadow: 0 8px 20px rgba(15,23,42,0.1);} /* Mejora visual en hover */
  .balance{display:flex;flex-direction:column;gap:8px}
  .balance .label{color:var(--muted);font-size:13px}
  .big{font-size:28px;font-weight:700}
  .muted{color:var(--muted);font-size:13px}
  label{display:block;font-size:13px;margin-bottom:6px;color:#111}
  input[type="number"]{width:100%;padding:10px;border-radius:8px;border:1px solid #e5e7eb;font-size:14px; min-height: 44px;} /* Altura mínima para táctil */
  button{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer; min-height: 44px;} /* Altura mínima para táctil */
  button.secondary{background:#eef2ff;color:var(--accent);border:1px solid rgba(11,116,255,0.12)}
  .actions{display:flex;gap:10px;align-items:center;margin-top:10px}
  .log{margin-top:12px;background:#fff7ed;border:1px solid #ffedd5;padding:10px;border-radius:8px;color:#92400e;font-size:13px}
  ul.list{padding-left:18px;margin:8px 0;}
  .status{display:flex;gap:8px;align-items:center}
  .dot{width:10px;height:10px;border-radius:50%;}
  .dot.ok{background:var(--success)}
  .dot.warn{background:#f59e0b}
  .hint{color:var(--muted);font-size:13px;margin-top:8px}
  .footer{margin-top:18px;color:var(--muted);font-size:13px}
  .bigcard{display:flex;flex-direction:column;gap:10px}
  .center{display:flex;align-items:center;justify-content:center}
  .reader{height:110px;border-radius:10px;border:2px dashed #e6eefc;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px}
  .animate{transition:all .28s ease}
  .pulse{animation:pulse 1s ease-out 0s 1}
  @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}
  .small{font-size:12px;color:var(--muted)}
  footer{margin-top:20px;text-align:center;color:var(--muted);font-size:13px}
  pre{white-space:pre-wrap;word-break:break-word;font-size:13px}

  /* --- Estilos para los Modales --- */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7); /* Fondo oscuro transparente */
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    backdrop-filter: blur(2px);
  }
  .modal-content {
    background: var(--card);
    padding: 30px;
    border-radius: 16px;
    width: 90%;
    max-width: 400px;
    text-align: center;
    position: relative;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    transform: translateY(-50px);
    opacity: 0;
    animation: fadeInDown 0.3s ease forwards;
  }
  .modal-icon {
    font-size: 50px;
    margin-bottom: 10px;
    line-height: 1;
  }
  /* Modal de Éxito */
  #successModal .modal-icon { color: var(--success); }
  .success-amount { color: var(--success); font-size: 36px; margin: 15px 0; font-weight: 700; }
  /* Modal de Error */
  .error-content { animation: fadeInDown 0.3s ease forwards, shake 0.5s; }
  #errorModal .modal-icon { color: var(--error); }
  
  @keyframes fadeInDown {
    to { transform: translateY(0); opacity: 1; }
  }
  @keyframes shake {
      0% { transform: translateX(0) translateY(0); }
      20% { transform: translateX(-10px) translateY(0); }
      40% { transform: translateX(10px) translateY(0); }
      60% { transform: translateX(-10px) translateY(0); }
      80% { transform: translateX(10px) translateY(0); }
      100% { transform: translateX(0) translateY(0); }
  }

  /* --- Media Query para Dispositivos Móviles (Diseño Responsivo) --- */
  @media (max-width: 600px) {
    .grid { grid-template-columns: 1fr; gap: 16px; }
    .wrap { margin: 10px auto; padding: 10px; }
    .big { font-size: 24px; }
    .actions { flex-direction: column; gap: 8px; }
    .actions button { width: 100%; text-align: center; }
    .modal-content { padding: 20px; }
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Simulador de Recarga NFC - Mexibús (Prototipo)</h1>
      <p class="lead">Simula tocar la tarjeta NFC con el celular para recargar y descontar saldo del "monedero" del usuario.</p>
    </div>
  </header>

  <div class="grid">
    <section class="card">
      <div class="bigcard">
        <div class="balance">
          <div class="label">Saldo tarjeta Mexibús</div>
          <div id="cardBalance" class="big"> $ <span>25.00</span> </div>
          <div class="muted small">Saldo del dispositivo (monedero virtual)</div>
          <div id="walletBalance" class="big"> $ <span>150.00</span> </div>
        </div>

        <div style="margin-top:10px">
          <label for="amount">Monto a recargar (MXN)</label>
          <input id="amount" type="number" min="1" step="1" value="20" inputmode="numeric" />
          <div class="actions">
            <button id="simulateTap">Simular acercar tarjeta (Tap)</button>
            <button id="tryWebNFC" class="secondary">Intentar con Web NFC</button>
          </div>
          <div class="hint">Si tu navegador no soporta Web NFC, usa "Simular acercar tarjeta".</div>
        </div>

        <div id="log" class="log" aria-live="polite">Registro de actividad: listo para simular.</div>
      </div>
    </section>

    <aside class="card">
      <div>
        <div class="status">
          <div class="dot ok" id="readerDot"></div>
          <div><strong id="readerStatus">Modo simulación</strong></div>
        </div>

        <div style="margin-top:12px" class="reader animate" id="readerArea">
          <div class="small">Área de lectura NFC</div>
          <div class="muted small">Acerca la tarjeta (simulación) o usa Web NFC</div>
        </div>

        <div style="margin-top:12px">
          <strong>Instrucciones rápidas</strong>
          <ul class="list">
            <li>Ingresa el monto a recargar.</li>
            <li>Pulsa "Simular acercar tarjeta" para emular el tap.</li>
            <li>Verifica que el saldo de la tarjeta aumente y el monedero disminuya.</li>
          </ul>
        </div>

        <div class="footer">
          <div><strong>Nota:</strong> El <em>Web NFC</em> sólo funciona en navegadores compatibles (Android Chrome, sitio seguro).</div>
        </div>
      </div>
    </aside>
  </div>

  <footer>
    Prototipo para demostración — no realiza transacciones reales. Guarda este archivo y ábrelo en tu navegador.
  </footer>
</div>

<div id="successModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <div class="modal-icon">&#10003;</div>
        <h2>¡Recarga Exitosa!</h2>
        <p>Se ha transferido exitosamente el monto de:</p>
        <div id="rechargeAmountDisplay" class="big success-amount"></div>
        <p>Tu **nuevo saldo** de la tarjeta es: <strong id="newCardBalanceDisplay"></strong></p>
        <p class="muted">El saldo de tu monedero virtual se ha actualizado.</p>
        <button id="closeModalButton">Aceptar</button>
    </div>
</div>
<div id="errorModal" class="modal-overlay" style="display:none;">
    <div class="modal-content error-content">
        <div class="modal-icon">&#9888;</div>
        <h2>¡Error de Lectura!</h2>
        <p id="errorMessageText"></p>
        <button id="closeErrorModalButton">Entendido</button>
    </div>
</div>
<script>
(function(){
  // numeric helper: ensure decimal arithmetic correctness using integer cents
  function toCents(x){ return Math.round(Number(x)*100); }
  function fromCents(c){ return (c/100).toFixed(2); }

  // initial balances in MXN
  let cardBalanceC = toCents(25.00);
  let walletBalanceC = toCents(150.00);

  const cardBalanceEl = document.querySelector('#cardBalance span');
  const walletBalanceEl = document.querySelector('#walletBalance span');
  const logEl = document.getElementById('log');
  const readerArea = document.getElementById('readerArea');
  const readerDot = document.getElementById('readerDot');
  const readerStatus = document.getElementById('readerStatus');
  const simulateTapButton = document.getElementById('simulateTap'); 
  const amountInput = document.getElementById('amount'); 

  // Elementos del Modal de Éxito
  const successModal = document.getElementById('successModal');
  const rechargeAmountDisplay = document.getElementById('rechargeAmountDisplay');
  const newCardBalanceDisplay = document.getElementById('newCardBalanceDisplay');
  const closeModalButton = document.getElementById('closeModalButton');
  
  // Elementos del Modal de Error
  const errorModal = document.getElementById('errorModal');
  const errorMessageText = document.getElementById('errorMessageText');
  const closeErrorModalButton = document.getElementById('closeErrorModalButton');
  

  function refreshUI(){
    cardBalanceEl.textContent = fromCents(cardBalanceC);
    walletBalanceEl.textContent = fromCents(walletBalanceC);
  }
  refreshUI();

  function writeLog(msg){
    const now = new Date().toLocaleTimeString();
    logEl.textContent = now + " — " + msg;
  }

  function pulseReader(){
    readerArea.classList.add('pulse');
    setTimeout(()=>readerArea.classList.remove('pulse'),900);
  }
  
  // Lógica para cerrar el modal de Éxito
  function closeModal(){
    successModal.style.display = 'none';
    readerStatus.textContent = "Modo simulación";
    readerDot.className = 'dot ok';
  }
  closeModalButton.addEventListener('click', closeModal);
  
  // Lógica para cerrar el modal de Error
  function showErrorModal(msg){
    errorMessageText.textContent = msg;
    errorModal.style.display = 'flex';
    readerStatus.textContent = "Modo simulación";
    readerDot.className = 'dot ok';
  }
  function closeErrorModal(){
    errorModal.style.display = 'none';
  }
  closeErrorModalButton.addEventListener('click', closeErrorModal);


  simulateTapButton.addEventListener('click', function(){
    const raw = amountInput.value;
    if(raw === "" || Number(raw) <= 0){ alert("Ingresa un monto válido (mayor a 0)."); return; }
    const amountC = toCents(raw);
    if(amountC > walletBalanceC){ alert("Saldo insuficiente en el monedero virtual."); return; }
    
    // Deshabilitar el botón y mostrar estado de procesamiento
    simulateTapButton.disabled = true;
    simulateTapButton.textContent = "Procesando Recarga...";

    readerStatus.textContent = "Tarjeta detectada y procesando pago...";
    readerDot.className = 'dot ok';
    pulseReader();

    setTimeout(()=>{
      // Transferencia simulada
      walletBalanceC -= amountC;
      cardBalanceC += amountC;
      refreshUI();
      
      // Mostrar modal de éxito
      rechargeAmountDisplay.textContent = "$ " + fromCents(amountC);
      newCardBalanceDisplay.textContent = "$ " + fromCents(cardBalanceC);
      successModal.style.display = 'flex';
      
      writeLog("Recarga exitosa: $" + fromCents(amountC) + " transferidos. (Ver notificación)");
      
      // Restablecer el botón
      simulateTapButton.disabled = false;
      simulateTapButton.textContent = "Simular acercar tarjeta (Tap)";
      
    }, 1500); // 1.5 segundos de simulación
  });

  // Web NFC: Función de Lectura con Manejo de Errores de Compatibilidad
  document.getElementById('tryWebNFC').addEventListener('click', async function(){
    if(!('nfc' in navigator) && !('NDEFReader' in window)){
      alert("Web NFC no está disponible en este navegador. Usa la simulación.");
      return;
    }
    
    let ndefReadSuccess = false; 

    try{
      readerStatus.textContent = "Esperando tag NFC... (acerca la tarjeta)";
      readerDot.className = 'dot warn';
      const ndef = new NDEFReader();
      
      await ndef.scan();
      
      // Temporizador para simular falla si detecta algo pero no es NDEF (tarjeta de transporte/banco)
      const scanTimeout = setTimeout(() => {
          if (!ndefReadSuccess) {
              readerDot.className = 'dot warn';
              
              // Llamada a la nueva función de error
              showErrorModal("Tarjeta de Transporte o Bancaria Detectada. No compatible con Web NFC. Por favor, pruebe con una tarjeta NFC virgen que contenga un mensaje NDEF.");
              writeLog("Lectura NFC: Tarjeta detectada, pero el formato no es compatible (no es NDEF).");
          }
      }, 3000); // 3 segundos para dar tiempo a la lectura

      ndef.onreading = event => {
        clearTimeout(scanTimeout); // Si hay lectura NDEF, cancelamos el temporizador de error
        ndefReadSuccess = true;     
        
        readerDot.className = 'dot ok';
        readerStatus.textContent = "Tag NFC leído (simulado acción)";
        pulseReader();
        
        // Lógica de recarga real si la lectura es exitosa
        const raw = prompt("Tag NDEF detectado. Ingresa monto a recargar (MXN):", "20");
        if(raw === null) { writeLog("Lectura NFC: acción cancelada por usuario."); return; }
        const amountC = toCents(raw);
        if(isNaN(amountC) || amountC <= 0){ alert("Monto inválido."); writeLog("Lectura NFC: monto inválido."); return; }
        if(amountC > walletBalanceC){ alert("Saldo insuficiente en el monedero virtual."); writeLog("Lectura NFC: saldo insuficiente."); return; }
        
        walletBalanceC -= amountC;
        cardBalanceC += amountC;
        refreshUI();
        
        // Mostrar modal de éxito
        rechargeAmountDisplay.textContent = "$ " + fromCents(amountC);
        newCardBalanceDisplay.textContent = "$ " + fromCents(cardBalanceC);
        successModal.style.display = 'flex';
        
        writeLog("Recarga via Web NFC: $" + fromCents(amountC) + " transferidos. (Ver notificación)");
      };

      await ndef.onreadingerror; 

    }catch(err){
      console.error(err);
      alert("Error al intentar usar Web NFC: " + (err.message || err));
      readerStatus.textContent = "Modo simulación";
      readerDot.className = 'dot ok';
    }
  });

})();
</script>

</body>
</html>